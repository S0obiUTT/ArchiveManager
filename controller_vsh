#!/bin/bash

#########################################
#										#
#	@Author : Kevin Personnic			#
#	@Date   : 17/05/2014				#
#	@Synop  : Controller vsh			#
#										#
#########################################

#communication const messages
declare -r archNotFound="ARCHNOTFOUND"
declare -r dirNotFound="DIRNOTFOUND"
declare -r dirFound="DIRFOUND"

#keywords
declare -r directoryKey="directory"

#environment variables
declare -r archivesDir="archives"


#check if a given directory exist
function vsh_existDir {
	#clean path of begining / and finishing /
	#cleanPath="$(sed -e "s/\(^\/\|\/$\)//g" <<< $1)"
	cleanPath="$1"

	# if directory is found in the archive
	if (( $(grep -c "^directory\ $cleanPath$" "$archivePath") == 0 )); then
		echo "0"
	else
		echo "1"
	fi
}

#check if a given archive exist
function vsh_existArch {
	found="0"

	for file in $archivesDir/*
	do
		if [[ -n $(sed -e "s/^$archivesDir\///g" <<< $file | grep "^$1\$") ]]; then
			found="1"
		fi
	done

	echo "$found"
}

#list the file of a directory
function vsh_ls {

	path="$localRoot${cmdLineArray[3]}"

	if ! (( $(vsh_existDir $path) )); then
		echo "$dirNotFound"
		return
	fi

	lineStart=$(( $(grep -n "$path\$" "$archivePath" | cut -d: -f1) + 1 ))
	nbLines=$(( $(tail -n +$lineStart "$archivePath" | grep -n -m 1 "@" | cut -d: -f1) - 1 ))
	dirContent="$(tail -n +$lineStart "$archivePath" | head -"$nbLines" )"

	#à re-écrire plus proprement
	echo "$(sed -e 's/\sd.*/\//g' <<< "$dirContent" | sed -e 's/\s...x..x..x.*\|\s...x..x.*\|\s...x.*/\*/g' | sed -e 's/\s.*//g' | awk 1 ORS=' ')"

}

#move to an other directory
function vsh_cd {
	path="$localRoot${cmdLineArray[3]}"

	if ! (( $(vsh_existDir $path) )); then
		echo "$dirNotFound"
		return
	fi
}

#list the available archives
function vsh_list {

	for file in $archivesDir/*
	do
		echo "$(sed -e "s/^$archivesDir\///g" <<< $file)"
	done
}

function vsh_cat {
	true;
}

function vsh_rm {
	true;
}

function vsh_browse {
	cmd="${cmdLineArray[2]}"

	#check if the archive exist
	if ! (( $(vsh_existArch ${cmdLineArray[1]}) )); then
		echo "$archNotFound"
		return
	fi

	localRoot="$(grep -m 1 "$directoryKey" "$archivePath" | sed -e "s/\($directoryKey\ \|\/$\)//g")"

	case "$cmd" in
		ls )
			vsh_ls;
			;;
		cd )
			vsh_cd;
			;;
		cat )
			vsh_cat;
			;;
		rm )
			vsh_rm;
			;;
		*)
			;;
	esac
}

function vsh_extract {
	#check if the archive exist
	if ! (( $(vsh_existArch ${cmdLineArray[1]}) )); then
		echo "$archNotFound"
		return
	fi

	#return all the content of the archive to the client
	cat $archivePath
}

read cmdLine
cmdLineArray=(${cmdLine// / })

declare action="${cmdLineArray[0]}"
declare localRoot=""
declare archivePath="$archivesDir/${cmdLineArray[1]}"

case "$action" in
	list )
		vsh_list;
		;;
	browse )
		vsh_browse;
		;;
	extract )
		vsh_extract;
		;;
	*)
		;;
esac